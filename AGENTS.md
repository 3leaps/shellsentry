# shellsentry - AI Agent Guide

## Read First

1. Check `AGENTS.local.md` if it exists (gitignored, tactical session guidance)
2. Read `MAINTAINERS.md` for contacts and governance
3. Review this document for operational protocols
4. Understand: this is a **security-focused CLI tool** - correctness and auditability matter

## Operating Model

| Aspect | Setting                                  |
| ------ | ---------------------------------------- |
| Mode   | Supervised (human reviews before commit) |
| Role   | Development Lead (`devlead`)             |

Supervised sessions do not have persistent identity. The supervising maintainer
(see MAINTAINERS.md) is the Committer-of-Record for all commits.

See [3leaps Crucible agent-identity standard](https://github.com/3leaps/crucible/blob/main/docs/repository/agent-identity.md)
for operating modes and attribution patterns.

## Roles

| Role      | Source                                                                 | Customization         |
| --------- | ---------------------------------------------------------------------- | --------------------- |
| `devlead` | [crucible baseline](https://crucible.3leaps.dev/catalog/roles/devlead) | —                     |
| `qa`      | [crucible baseline](https://crucible.3leaps.dev/catalog/roles/qa)      | See [below](#role-qa) |
| `secrev`  | [crucible baseline](https://crucible.3leaps.dev/catalog/roles/secrev)  | —                     |

### Role: qa

Extends [crucible qa baseline](https://crucible.3leaps.dev/catalog/roles/qa).

#### Additional Scope

- Dogfood testing against real-world install scripts
- False positive/negative analysis for pattern detection
- Exit code validation across test scenarios
- Cross-platform shell dialect testing (bash, sh, zsh)

#### Dogfood Protocol

1. Fetch real install scripts (homebrew, rustup, deno, nvm, etc.)
2. Run shellsentry against each, record findings
3. Manually verify findings (true positive vs false positive)
4. Document missed patterns (false negatives)
5. Report findings in `.plans/` task artifacts

## Project Context

**shellsentry** is a static analyzer for shell scripts, designed as a companion to [sfetch](https://github.com/3leaps/sfetch). While sfetch handles secure acquisition with signature verification, shellsentry handles content assessment.

Key principles:

- **Small and auditable** - Single binary, minimal dependencies, readable source
- **No network by default** - All analysis is local
- **Composable** - Stdin/stdout, JSON output, Unix exit codes
- **Honest about limitations** - Static analysis can't catch everything; we say so

## Quick Reference

| Task         | Command          |
| ------------ | ---------------- |
| Build        | `make build`     |
| Test         | `make test`      |
| Lint         | `make lint`      |
| Format       | `make fmt`       |
| All checks   | `make check-all` |
| Clean        | `make clean`     |
| Show version | `make version`   |

## Session Protocol

### Before Changes

1. Read relevant code first
2. Understand the scope - this is security tooling
3. Keep changes minimal and focused
4. Consider: does this change affect the trust model?

### Before Committing

1. Run `make check-all`
2. Verify tests pass
3. Use proper attribution (see below)
4. Include `Committer-of-Record` trailer

### Commit Attribution

```
<type>(<scope>): <subject>

<body>

Generated by Claude Sonnet via Claude Code under supervision of @<maintainer>

Co-Authored-By: Claude Sonnet <noreply@3leaps.net>
Committer-of-Record: @<maintainer>
```

Check `MAINTAINERS.md` for the supervising maintainer for your session.

## Architecture Notes

```
shellsentry/
├── internal/
│   ├── analyzer/     # Analysis engines (Level 0, Level 1)
│   ├── output/       # Formatters (human, JSON, SARIF)
│   ├── parser/       # mvdan/sh wrapper
│   └── patterns/     # Pattern matching engine
├── patterns/         # Source patterns (embedded at build)
│   ├── high/         # High-risk patterns
│   ├── medium/       # Medium-risk patterns
│   └── low/          # Low-risk/informational
├── schemas/          # JSON Schema for output validation
├── docs/             # Documentation
└── main.go           # CLI entry point
```

### Key Design Decisions

- **`internal/` only** - No `pkg/` exports; CLI is the interface
- **Embedded patterns** - `//go:embed` for single-binary distribution
- **Exit codes are API** - 0=clean, 1=info, 2=warning, 3=danger, 4=error

## DO

- Run quality gates before commits
- Read files before editing them
- Keep changes focused
- Document pattern rationale
- Consider false positive rates
- Test against real-world install scripts

## DO NOT

- Push without maintainer approval
- Skip quality gates
- Add network features (unless explicitly scoped)
- Break exit code contract
- Add dependencies without discussion
- Touch code outside task scope
- **Commit `.plans/` directory or files** - This is excluded from the public repo via .gitignore

## Standards Reference

- **Online**: https://crucible.3leaps.dev/ (when available)
- **Fallback**: `../crucible/` sibling directory
- **Full Spec**: https://github.com/3leaps/crucible

## Related Projects

- [sfetch](https://github.com/3leaps/sfetch) - Secure artifact downloader (companion tool)
- [crucible](https://github.com/3leaps/crucible) - 3leaps standards baseline
